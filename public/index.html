<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ì½”ì¹­ìŠ¤íƒœí”„ íšŒì˜ë¡</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: auto; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        input, textarea { width: 90%; padding: 5px; }
        .btn-box { margin-top: 10px; display: flex; gap: 10px; }
    </style>
</head>
<body>
    
    
    
    <div class="container">
        <h1>ğŸ“ íšŒì˜ë¡ ì‘ì„±</h1>
        ë‚ ì§œ: <input type="date" id="meetingDate">
        
        <table id="meetingTable">
            <thead>
                <tr>
                    <th>ì„±ëª…</th>
                    <th>ì§ì±…</th>
                    <th>ë©˜ì…˜ (ë‚´ìš©)</th>
                    <th>ê´€ë¦¬</th> </tr>
                </tr>
            </thead>
            <tbody id="attendeeBody">
                </tbody>
        </table>

        <div class="btn-box">
            <button onclick="addRow()">â• ì¤„ ì¶”ê°€</button>
            <button onclick="saveAll()" style="background: #28a745; color: white;">ğŸ’¾ DB ì €ì¥</button>
        </div>

        <div style="text-align: right; margin-bottom: 10px;">
    <a href="daily.html" style="font-size: 12px; font-weight: bold; color: green;">ğŸ“… ì˜¤ëŠ˜ íšŒì˜ë¡ ê²°ê³¼ë³´ê¸°</a>
</div>
    </div>

    <script>
// 1. í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
window.onload = async function() {
    // ì˜¤ëŠ˜ ë‚ ì§œ ì„¸íŒ…
    const today = new Date().toISOString().substring(0, 10);
    document.getElementById('meetingDate').value = today;

    // ì–´ì œ ë‚ ì§œ ê³„ì‚° (ì˜¤ëŠ˜ - 1ì¼)
    const d = new Date();
    d.setDate(d.getDate() - 1);
    const yesterday = d.toISOString().substring(0, 10);

    console.log("ì–´ì œ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œë„:", yesterday);

    try {
        // ì–´ì œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜´ (ì´ë¯¸ ì„œë²„ì˜ load-meetingì€ log_num ìˆœìœ¼ë¡œ ì¤Œ)
        const res = await fetch(`/load-meeting?date=${yesterday}`);
        const data = await res.json();

        const tbody = document.getElementById('attendeeBody');
        tbody.innerHTML = ''; // ê¸°ë³¸ ì¹¸ ë¹„ìš°ê¸°

        if (data && data.length > 0) {
            // ì–´ì œ ëª…ë‹¨ì´ ìˆìœ¼ë©´ ìˆœì„œëŒ€ë¡œ ì´ë¦„/ì§ì±… ì±„ìš°ê¸°
           // window.onload ë‚´ë¶€ì˜ data.forEach ë¶€ë¶„
data.forEach(item => {
    const row = tbody.insertRow();
    row.innerHTML = `
        <td><input type="text" class="nameInput" value="${item.name}" onblur="findRole(this)"></td>
        <td><input type="text" class="roleInput" value="${item.role}" readonly style="background:#f9f9f9"></td>
        <td><textarea class="mentionInput" placeholder="ì˜¤ëŠ˜ì˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea></td>
        <td>
            <button onclick="addRow(this)">â•</button>
            <button onclick="deleteRow(this)" style="color:red">âŒ</button>
        </td>
    `;
});
            console.log("âœ… ì–´ì œ ëª…ë‹¨ ë¡œë“œ ì™„ë£Œ!");
        } else {
            // ì–´ì œ ê¸°ë¡ì´ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ë¹ˆ ì¤„ í•˜ë‚˜ ìƒì„±
            addRow();
        }
    } catch (e) {
        console.error("ì–´ì œ ë°ì´í„° ë¡œë“œ ì¤‘ ì—ëŸ¬:", e);
        addRow(); // ì—ëŸ¬ ë‚˜ë©´ ë¹ˆ ì¤„ì´ë¼ë„ í•˜ë‚˜ ë„ì›Œì¤Œ
    }
};

        // ë‚ ì§œ ê¸°ë³¸ê°’
        document.getElementById('meetingDate').value = new Date().toISOString().substring(0, 10);

        // ì¤„ ì¶”ê°€
        // 1. ì¤„ ì¶”ê°€ í•¨ìˆ˜ (ìˆ˜ì •: index íŒŒë¼ë¯¸í„° ì¶”ê°€)
function addRow(el = null) {
    const tbody = document.getElementById('attendeeBody');
    let newRow;

    if (el) {
        // [ì¤‘ê°„ ì¶”ê°€] ë²„íŠ¼ì„ ëˆ„ë¥¸ ìœ„ì¹˜ ë°”ë¡œ ì•„ë˜ì— ì‚½ì…
        const currentRow = el.parentElement.parentElement;
        newRow = tbody.insertRow(currentRow.rowIndex); // í˜„ì¬ ì¤„ ë²ˆí˜¸ì— ì‚½ì…
    } else {
        // [ê·¸ëƒ¥ ì¶”ê°€] ë§¨ ì•„ë˜ì— ì‚½ì…
        newRow = tbody.insertRow();
    }

    newRow.innerHTML = `
        <td><input type="text" class="nameInput" onblur="findRole(this)"></td>
        <td><input type="text" class="roleInput" readonly style="background:#f9f9f9"></td>
        <td><textarea class="mentionInput"></textarea></td>
        <td>
            <button onclick="addRow(this)">â•</button>
            <button onclick="deleteRow(this)" style="color:red">âŒ</button>
        </td>
    `;
}

// 2. ì¤„ ì‚­ì œ í•¨ìˆ˜
function deleteRow(el) {
    if (confirm("ì´ ì¤„ì„ ì‚­ì œí• ê¹Œ?")) {
        const row = el.parentElement.parentElement;
        row.remove();
    }
}

        // ì§ì±… ì°¾ê¸°
        async function findRole(input) {
            if (!input.value) return;
            const row = input.parentElement.parentElement;
            try {
                const res = await fetch(`/get-role?name=${encodeURIComponent(input.value)}`);
                const data = await res.json();
                row.querySelector('.roleInput').value = data.role;
            } catch (e) {
                console.error("ì§ì±… ë¡œë“œ ì‹¤íŒ¨:", e);
            }
        }

        // ì €ì¥í•˜ê¸°
        async function saveAll() {
            const date = document.getElementById('meetingDate').value;
            const rows = document.querySelectorAll('#attendeeBody tr');
            const attendees = [];

            rows.forEach(row => {
                const name = row.querySelector('.nameInput').value;
                const role = row.querySelector('.roleInput').value;
                const mention = row.querySelector('.mentionInput').value;
                if (name) attendees.push({ name, role, mention });
            });

            if (attendees.length === 0) return alert("ë°ì´í„°ë¥¼ ì…ë ¥í•´ì¤˜!");

            try {
                const res = await fetch('/save-meeting', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date, attendees })
                });
                const result = await res.json();
                alert(result.message || "ì—ëŸ¬ ë°œìƒ: " + result.error);
            } catch (e) {
                alert("ì„œë²„ì™€ ì—°ê²°í•  ìˆ˜ ì—†ì–´! í„°ë¯¸ë„ í™•ì¸í•´ë´.");
            }
        }

        // ì‹œì‘í•˜ìë§ˆì í•œ ì¤„ ë§Œë“¤ê¸°
        addRow();
    </script>
</body>
</html>