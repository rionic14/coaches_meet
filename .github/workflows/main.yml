name: Deploy to NAS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH Remote Commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.NAS_HOST }}
          username: ${{ secrets.NAS_USERNAME }}
          password: ${{ secrets.NAS_PASSWORD }}
          port: ${{ secrets.NAS_PORT }}
          script: |
            # 1. 경로 이동
            cd /volume1/web/coaches_meet || exit 1
            
            # 2. 코드 업데이트
            git pull origin main
            
            # 3. 시놀로지 전용 NPM/NODE 경로 강제 로드
            export PATH=$PATH:/usr/local/bin:/usr/bin:/bin:/volume1/@appstore/Node.js_v18/usr/local/bin
            
            # 4. npm install (에러 나도 일단 진행)
            npm install || /usr/local/bin/npm install || echo "NPM skipped"
            
            # 5. PM2 재시작 (가장 확실한 sudo 방법)
            # -S 옵션과 함께 비번을 파이프로 넘겨줌
            echo "${{ secrets.NAS_PASSWORD }}" | sudo -S /usr/local/lib/node_modules/pm2/bin/pm2 restart coaches_meet
